<%= form_for(card) do |f| %>
  <% if card.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(card.errors.count, "error") %> prohibited this card from being saved:</h2>

      <ul>
      <% card.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>
  <div class="form-group card" >
    <div id="card-form">
      <%= f.label :title, "Title"%>
      <%= f.text_field :title, class: "form-control", id:"title-field", :required => true%><br>

      <%= f.label :type, "Card Data Type"%>
      <%= f.select :type, options_for_select([["Pie Chart", "pie_chart"],["Bar Graph", "bar_graph"],["Grouped Bar Graph", "grouped_bar_graph"],["Donut Chart", "donut_chart"]]),{}, class: "form-control", id: "card-data-type-select" %>
      <br>
      <%= f.label :level, "Data Access Level" %>
      <%= f.select :level, options_for_select([[],["School Wide", "school_wide"],["Division", "Division"],["Department", "department"],["Supervisor", "supervisor"]]),{}, class: "form-control" %>
      <br>
      <%= f.label :datasets, "Data Source"%>
      <%= f.select :datasets,options_for_select([["none", "none"]]) + options_from_collection_for_select(@datasets, "id", "name", []),{}, class: "form-control", id: "dataset-select" %>
      </div>
    <br>

    <div class="actions">
      <%= f.submit class: "btn", id:"card-submit", :disabled => true%>
    </div>
  </div>

<% end %>
</div>

<div class="col-sm-4">
  <h1> Preview </h1>


  <!-- RENDER ALL THE CARD TEMPLATES IN VIEWS/LAYOUTS -->

  <div class="card-preview card inline" id="pie_chart">
    <div class="center-block">
      <h5 class='card-title text-center'></h5>
      <%= render 'layouts/pie_chart'%>
    </div>
  </div>

  <div class="card-preview card" id="bar_graph">
    <div class="">
      <h5 class='card-title text-center'></h5>
      <%= render 'layouts/bar_graph'%>
    </div>
  </div>

  <div class="card-preview card" id="grouped_bar_graph">
    <div class="">
      <h5 class='card-title text-center'></h5>
      <%= render 'layouts/grouped_bar_graph'%>
    </div>
  </div>

  <div class="card-preview card inline" id="donut_chart">
    <div class="center-block">
      <h5 class='card-title text-center'></h5>
      <%= render 'layouts/donut_chart'%>
    </div>
  </div>

  <!-- RUN JS TO UPDATE PREVIEW -->

  <script>
  $( ".card-preview" ).each(function( index ) {
    var $to_fixed = $( this );

    $to_fixed.width( $to_fixed.width() );
  });

  function show_card(){
    var val = $('#card-data-type-select').val();
    $('.card-preview').hide();
    $("#"+val).show();
  }
  function render_text(){
    var title = $('#title-field').val();
    $('.card-title').text(title);
  }
  $('.card-preview').hide(); //hide all templates
  show_card(); // show the one currently selected
  $("#card-data-type-select").change(show_card).change(render_text); //when select changed

  $("#title-field").keyup(render_text);


//SEND TO ANOTHER FILE

$("#dataset-select").change( function(){
  $.post('/get_columns.json', { dataset_id: $(this).val() },
    function(data){
      buildColumnsSelect(data);
    });
});

function buildColumnsSelect(columns){
  var l = $("<label for='column'>Target</label>");
  var s = $("<select id='column-select' name='column' class='form-control'/>");
  jQuery.each(columns, function(index, val){
    $("<option />", {value: val, text: val}).appendTo(s);
  });
  if ($("#column-select").length){
    $("#column-select").replaceWith(s);
  } else {
  $("#card-form").append('<br>');
  $("#card-form").append(l);
  $("#card-form").append(s);
    
  }

  s.change( function(){
    $.post('/get_actions.json', { dataset_id: $("#dataset-select").val(), column_name: s.val() },
      function(data){
        console.log(data);
      });
  });
}
// disable the button when a dataset is not selected
// we need to enable the button only when we have all of the information needed to make a card
$("#dataset-select").change( function(){
  if ($(this).val() == 'none'){
    $("#card-submit").prop('disabled', true);
  }
});

  </script>
